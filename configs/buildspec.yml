version: 0.2
phases:
  install:
    commands:
      - echo "Installing dependencies"
      - pip install pytest flake8 pylint
        
  pre_build:
    commands:
      - echo "Running linting and static code analysis"
      - flake8 dags/ --max-line-length=120  # Check code formatting
      - pylint dags/  # Run static code analysis
      
  build:
    commands:
      - echo "Identifying modified DAGs"
      - modified_files=$(find ./dags -type f -mmin -10)
      - python -m pytest -v $modified_files
      - echo "Running unit tests"
      - pytest ./tests/  # Run all tests in the `tests` folder
      
  post_build:
    commands:
      - echo "Testing completed successfully"
      - echo "Deploying DAGs and scripts to S3"
      - aws s3 sync ./dags s3://airflow-dags-production-bucket-new/dags --delete --size-only
      - aws s3 sync ./scripts s3://airflow-dags-production-bucket-new/scripts --delete --size-only
      
