version: 0.2
phases:
  install:
    commands:
      - echo "Installing dependencies"
      # - pip install -r requirements.txt
      # - pip install pytest flake8 pylint apache-airflow==2.6.3 # Install testing and linting tools
      - pip install pytest
      - git fetch --all
        
  # pre_build:
  #   commands:
  #     - echo "Running linting and static code analysis"
  #     - flake8 dags/ --max-line-length=120  # Check code formatting
  #     - pylint dags/  # Run static code analysis
      
  build:
    commands:
      - echo "Identifying modified DAGs"
      - modified_files=$(git diff --name-only HEAD~1 HEAD | grep '^dags/.*\.py$')
      - echo "Modified files: $modified_files"
      - python -m pytest -v $MODIFIED_FILES
        
  # build:
  #   commands:
  #     - echo "Running unit tests"
  #     - pytest ./tests/  # Run all tests in the `tests` folder
      
  post_build:
    commands:
      - echo "Testing completed successfully"
      - echo "Deploying DAGs and scripts to S3"
      - aws s3 sync ./dags s3://airflow-dags-production-bucket-new/dags --delete --size-only
      - aws s3 sync ./scripts s3://airflow-dags-production-bucket-new/scripts --delete --size-only
      
